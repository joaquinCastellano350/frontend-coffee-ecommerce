<div class="page">
  <mat-card>
    <h1>{{ isEdit() ? 'Editar producto' : 'Nuevo producto' }}</h1>

    <form [formGroup]="form" (ngSubmit)="onSubmit()">
      <div class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="name" />
          <mat-error *ngIf="form.controls['name'].invalid && form.controls['name'].touched">
            El nombre es obligatorio
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Marca</mat-label>
          <input matInput formControlName="brand" />
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Categoría</mat-label>
          <mat-select
            formControlName="category_id"
            (selectionChange)="onCategoryChange($event.value)"
          >
            <mat-option *ngFor="let c of categories()" [value]="c._id">{{ c.name }}</mat-option>
            <mat-option value="__create__">Crear</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Catálogo</mat-label>
          <mat-select
            formControlName="catalog_id"
            (selectionChange)="onCatalogChange($event.value)"
          >
            <mat-option *ngFor="let c of catalogs()" [value]="c._id">{{ c.name }}</mat-option>
            <mat-option value="__create__">Crear</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Precio</mat-label>
          <input matInput type="number" formControlName="price" />
          <mat-error *ngIf="form.controls['price'].invalid && form.controls['price'].touched">
            El precio debe ser mayor que 0
          </mat-error>
        </mat-form-field>
        <mat-form-field appearance="outline">
          <mat-label>Stock</mat-label>
          <input matInput type="number" formControlName="stock" />
          <mat-error *ngIf="form.controls['stock'].invalid && form.controls['stock'].touched">
            El stock debe ser mayor que 0
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Descripción</mat-label>
          <textarea matInput formControlName="description" rows="4"></textarea>
        </mat-form-field>
        <mat-form-field appearance="outline" class="full">
          <mat-label>Tags</mat-label>

          <mat-chip-grid #chipGrid>
            <mat-chip-row
              *ngFor="let t of form.controls['tags'].value; let i = index"
              (removed)="removeTag(i)"
              [removable]="true"
            >
              {{ t }}
              <button matChipRemove aria-label="Remove tag"><mat-icon>cancel</mat-icon></button>
            </mat-chip-row>

            <input
              placeholder="Escribí y presioná Enter o coma"
              [matChipInputFor]="chipGrid"
              [matChipInputSeparatorKeyCodes]="separatorKeys"
              (matChipInputTokenEnd)="addTag($event)"
              [value]="''"
            />
          </mat-chip-grid>
        </mat-form-field>

        <div class="image-field full">
          <mat-label class="label">Imagen</mat-label>
          <input type="file" accept="image/*" (change)="onFileSelected($event)" />
          <div class="preview" *ngIf="imagePreview">
            <img [src]="imagePreview" alt="Vista previa" />
            <button mat-button color="warn" type="button" (click)="clearImage()">Eliminar</button>
          </div>
        </div>
      </div>

      <div class="actions">
        <a mat-stroked-button color="primary" href="/admin/products">Cancelar</a>
        <button mat-raised-button color="accent" type="submit" [disabled]="form.invalid">
          {{ isEdit() ? 'Guardar cambios' : 'Crear producto' }}
        </button>
      </div>
    </form>
  </mat-card>
</div>
